# AI Development Assistant — Workflow

## Роли

| Роль | Кто | Что делает |
|------|-----|-----------|
| Product Owner | Valentina | Ставит задачи, утверждает планы, приоритеты |
| Архитектор | Агент проекта | Проектирует структуру, БД, API, безопасность |
| Разработчик | Агент проекта | Пишет код |
| Code Reviewer | Codex (OpenAI gpt-5.2-codex) | Независимая проверка кода |
| QA | Агент проекта + Valentina | Автотесты + визуальная + ручная проверка |
| DevOps | Агент проекта | CI/CD, деплой, мониторинг |
| UI/UX контроль | Агент проекта | Консистентность интерфейса, адаптивность |

---

## Ветки Git

- `main` — **защищённая ветка**. Только проверенный код. Автодеплой на сервер. Прямые пуши ЗАПРЕЩЕНЫ.
- `dev` — черновик. Здесь пишем, ломаем, чиним.
- `feature/*` — отдельная ветка на каждую задачу. Создаётся от `dev`, вливается в `dev` через PR.
- **НИКОГДА не писать код сразу в main**

### Workflow веток:
```
feature/task-name → (PR) → dev → (PR + Codex review) → main → autodeploy
```

### Branch Protection (настроить на GitHub):
- `main`: запрет прямых пушей, обязательный PR, CI должен пройти
- Merge в main только через `gh pr create` → review → merge

---

## Цикл разработки (на каждую задачу)

### Шаг 1. Постановка задачи (Valentina)
- Valentina описывает что нужно сделать
- Можно голосом, текстом, скриншотом — как удобно

### Шаг 2. Анализ и план (Архитектор)
- Проанализировать задачу и текущий код
- Написать план на 3-5 пунктов
- Указать затронутые файлы
- Определить **критерии приёмки** (Definition of Done) — что значит «задача выполнена»
- Оценить риски (что может сломаться)
- **Ждать ОК от Valentina**

### Шаг 3. Подготовка (Setup)
```bash
git checkout dev
git pull origin dev
git checkout -b feature/название-задачи
```
- Убедиться что dev актуален (`git fetch origin`)
- Проверить `.env` файл на месте (скопировать из `.env.example` если нет)
- Убедиться что `node --version` соответствует проекту

### Шаг 4. Разработка (Developer)
- Маленькие изменения, НЕ переписывать файлы целиком
- После каждого изменения — проверка синтаксиса:
```bash
node --check файл.js
```
- Проверить что проект запускается без ошибок
- Коммитить часто в feature-ветку

### Шаг 5. Автотесты (QA автоматический)
```bash
npm test
```
- Все существующие тесты должны пройти
- Для новых функций — написать тесты
- Если тесты упали — исправить до следующего шага
- Стремиться к покрытию ≥70% для нового кода

### Шаг 6. Линтинг и форматирование (Code Quality)
```bash
npx eslint . --fix        # проверка стиля кода
npx prettier --write .    # форматирование
npm audit                 # проверка уязвимостей зависимостей
```
- Код должен соответствовать принятому стилю проекта
- Без неиспользуемых переменных, без console.log в продакшн-коде
- Единообразные отступы, кавычки, точки с запятой
- `npm audit` — если найдены HIGH/CRITICAL уязвимости, исправить до продолжения

### Шаг 7. Визуальная проверка UI (если менялся фронтенд)
Чеклист:
- [ ] Элементы не вылезают за пределы экрана
- [ ] Кнопки одинакового размера и стиля (как в существующем UI)
- [ ] Шрифты, цвета, отступы соответствуют дизайн-системе проекта
- [ ] Адаптивность: проверить на 320px (мобильный), 768px (планшет), 1280px (десктоп)
- [ ] Нет горизонтального скролла на мобильных
- [ ] Интерактивные элементы достаточного размера для нажатия пальцем (min 44x44px)
- [ ] Текст читаемый, контрастный (WCAG AA минимум)
- [ ] Загрузка страницы < 3 секунд
- [ ] Изображения оптимизированы (WebP, lazy loading)
- [ ] Анимации плавные, не мерцают
- [ ] Dark/Light mode (если поддерживается) — без артефактов

### Шаг 8. Чеклист безопасности (Security)
- [ ] Нет захардкоженных паролей/ключей/токенов в коде
- [ ] `.env` в `.gitignore` (проверить!)
- [ ] `.env.example` актуален (все нужные переменные, без реальных значений)
- [ ] Все входные данные валидируются (Joi или аналог)
- [ ] SQL-запросы параметризованы ($1, $2), нет конкатенации
- [ ] Нет innerHTML с пользовательскими данными без экранирования
- [ ] Ошибки обрабатываются, стектрейсы не утекают клиенту
- [ ] Новые endpoints защищены авторизацией
- [ ] Rate limiting на чувствительных endpoints (логин, API)
- [ ] CORS настроен только для разрешённых доменов
- [ ] Content-Security-Policy (CSP) настроен
- [ ] CSRF-защита на формах (SameSite cookies)
- [ ] Файлы загрузки проверяются (тип, размер)
- [ ] HTTP заголовки безопасности (Helmet.js)
- [ ] Нет открытых redirect-ов
- [ ] JWT: установлен expiry, используется refresh token

### Шаг 9. Performance-чеклист (если применимо)
- [ ] Нет N+1 запросов к БД
- [ ] Индексы на часто используемых полях WHERE/JOIN
- [ ] Размер бандла фронтенда разумный (проверить `npm run build`)
- [ ] Тяжёлые операции вынесены в фоновые задачи
- [ ] Пагинация на списочных endpoints

### Шаг 10. Коммит в feature-ветку и PR в dev
```bash
git add <конкретные файлы>   # НЕ git add .
git commit -m "feat: понятное описание на английском"
git push origin feature/название-задачи
gh pr create --base dev --title "feat: описание" --body "Что сделано, что проверено"
```
⚠️ **Никогда не использовать `git add .`** — можно случайно закоммитить секреты или мусор. Добавлять файлы явно.

Формат коммитов (Conventional Commits):
- `feat:` — новая функция
- `fix:` — исправление бага
- `refactor:` — рефакторинг без изменения поведения
- `style:` — форматирование, пробелы
- `docs:` — документация
- `test:` — добавление тестов
- `chore:` — настройка, зависимости

### Шаг 11. CI (GitHub Actions)
- Автоматически запускаются при push и PR:
  - `npm ci` (не `npm install` — для воспроизводимых сборок)
  - `npm test`
  - `npm audit --audit-level=high`
  - `npx eslint .`
- Если CI красный — исправить до merge

### Шаг 12. Codex Code Review (перед merge в main)
**Обязателен перед каждым merge dev → main.**

```bash
cd /путь/к/проекту && codex review --base main
```

Или через exec:
```bash
codex exec "Review the changes between dev and main branches. Check for: security vulnerabilities, performance issues, code quality, best practices, and consistency with existing code style."
```

Классификация замечаний:
- **CRITICAL** — исправить обязательно, блокирует merge
- **HIGH** — исправить обязательно
- **MEDIUM** — на усмотрение Valentina
- **LOW** — можно отложить, записать в backlog

Все CRITICAL и HIGH замечания должны быть исправлены до merge.

### Шаг 13. Документация (обязательно перед отчётом)
- Обновить **CHANGELOG.md** — что добавлено/исправлено в этом релизе
- Обновить **README.md** — если изменились инструкции по запуску, настройке или зависимости
- Обновить **API.md** — если изменились endpoints, параметры или форматы ответов
- Обновить **JSDoc** комментарии для новых/изменённых публичных функций
- Закоммитить обновления документации вместе с кодом

### Шаг 14. Отчёт для Valentina
Показать краткий отчёт:
- Что изменено (файлы, строки)
- Что проверено (тесты, безопасность, UI, performance)
- Результат Codex-ревью (замечания и их статус)
- Какая документация обновлена
- Скриншоты UI (если менялся фронтенд)
- **Ждать ОК от Valentina перед merge в main**

### Шаг 15. Merge в production (только через PR)
```bash
gh pr create --base main --head dev --title "Release: описание"
```
- PR должен пройти CI
- Codex-ревью пройден (все CRITICAL/HIGH исправлены)
- Valentina одобрила
- После merge → автодеплой на сервер

### Шаг 16. Бэкап и деплой
- **Бэкап БД перед деплоем:**
```bash
pg_dump -U postgres имя_бд > backup_$(date +%Y%m%d_%H%M%S).sql
```
- Автодеплой срабатывает при push в main (GitHub Actions → сервер)
- Проверить логи деплоя

### Шаг 17. Проверка после деплоя (Smoke Test)
- [ ] Сайт/приложение открывается
- [ ] Логин работает
- [ ] Основные функции работают (CRUD)
- [ ] API отвечает корректно
- [ ] Проверить с телефона (адаптивность)
- [ ] Проверить health endpoint: `GET /health`
- [ ] Проверить логи на ошибки
- [ ] Error-monitoring (Sentry) не показывает новых ошибок

---

## Если сломалось в production

### Простой откат (один коммит):
```bash
git checkout main
git revert HEAD
git push origin main
```
Автодеплой откатит за ~2 минуты.

### Сложный откат (несколько коммитов):
```bash
git checkout main
git log --oneline -10          # найти последний рабочий коммит
git revert HEAD~N..HEAD        # откатить N коммитов
git push origin main
```

### Если сломалось в dev:
```bash
git checkout dev
git revert HEAD
git push origin dev
```

Чиним в feature-ветке, повторяем цикл.

---

## Если сломалась БД:
```bash
# Восстановить из бэкапа
psql -U postgres имя_бд < backup_YYYYMMDD_HHMMSS.sql
```

---

## Правила (ОБЯЗАТЕЛЬНО)

1. **НИКОГДА** не писать код сразу в main
2. **НИКОГДА** не деплоить без тестов и Codex-ревью
3. **НИКОГДА** не хранить секреты в коде (только .env + .env в .gitignore)
4. **НИКОГДА** не использовать `git add .` — добавлять файлы явно
5. **ВСЕГДА** план → ОК → код → тесты → линт → audit → UI → безопасность → performance → Codex-ревью → **документация** → отчёт → ОК → PR → CI → merge → бэкап БД → деплой → smoke test
6. **Маленькие частые коммиты** лучше одного большого
7. **Максимум 1 задача** за раз
8. Если не уверен — **спроси Valentina**
9. Valentina не программист — объясняй простым языком
10. **Консистентность UI** — новые элементы должны выглядеть как существующие
11. **Не ломать существующее** — перед изменением убедиться что старый функционал работает
12. **Merge в main только через PR** с пройденным CI и Codex-ревью

---

## Работа с зависимостями

- Перед добавлением новой библиотеки — проверить:
  - Популярность (npm downloads, GitHub stars)
  - Дата последнего обновления (не заброшена ли)
  - Размер бандла (не раздувает ли проект)
  - Лицензия (MIT, Apache 2.0 — ОК; GPL — обсудить с Valentina)
- `npm ci` в CI (не `npm install`) — для воспроизводимых сборок
- `npm audit` после установки и перед каждым релизом
- Зафиксировать версии в package-lock.json (не использовать `^` или `~` для критичных пакетов)
- Периодически (раз в месяц): проверить обновления зависимостей, обновить с тестированием

---

## Работа с базой данных

- Все изменения схемы через миграции (файлы в migrations/)
- Никогда не менять БД напрямую в production
- **Бэкап перед миграцией И перед деплоем**
- Проверить что миграция обратима (rollback)
- Тяжёлые миграции (добавление индексов на большие таблицы) — делать с `CONCURRENTLY`

---

## Секреты и ключи

- Все секреты хранятся ТОЛЬКО в `.env` (никогда в коде)
- `.env` ВСЕГДА в `.gitignore`
- `.env.example` — шаблон со всеми переменными, но без реальных значений
- При ротации ключей: обновить `.env` на сервере → перезапустить сервис → проверить что работает
- API-ключи: периодически ротировать (раз в 3-6 месяцев)
- GitHub Secrets для CI/CD (не хранить ключи в workflow-файлах)

---

## Логирование и мониторинг

- Использовать уровни логов: error, warn, info, debug
- В production: error + warn + info
- **Не логировать**: пароли, токены, персональные данные, тела запросов с чувствительными данными
- Health endpoint для мониторинга: `GET /health`
- Error-monitoring: подключить Sentry (или аналог) для отслеживания ошибок в production
- После деплоя: проверить Sentry на новые ошибки

---

## Версионирование

- Использовать семантическое версионирование: `v1.0.0`, `v1.1.0`, `v2.0.0`
- Git-теги для каждого релиза: `git tag v1.0.0 && git push --tags`
- Вести `CHANGELOG.md`:
```markdown
## [1.1.0] - 2026-02-23
### Added
- Страница регистрации с валидацией
### Fixed
- XSS уязвимость в чат-листе
```

---

## Документация

- Обновить README.md если изменились инструкции по запуску
- Обновить API.md если изменились endpoints
- JSDoc комментарии для публичных функций
- Записать в memory что сделано (для контекста следующих сессий)

---

## Инструменты

| Что | Зачем |
|-----|-------|
| Git + GitHub | Версионирование кода |
| Jest + Supertest | Автотесты |
| ESLint + Prettier | Линтинг и форматирование |
| GitHub Actions | CI — автоматический запуск тестов |
| Codex CLI (OpenAI) | Независимый code review |
| PostgreSQL | База данных |
| Helmet.js | HTTP security headers (включая CSP) |
| bcrypt + JWT | Авторизация |
| Joi | Валидация данных |
| express-rate-limit | Защита от DDoS |
| Sentry | Error monitoring в production |

---

## Целевая структура проекта

```
project/
├── .github/workflows/   — CI конфигурация
├── scripts/
│   └── codex-review.sh  — скрипт code review
├── server/
│   ├── src/
│   │   ├── index.js         — точка входа
│   │   ├── db.js            — подключение к БД
│   │   ├── middleware/      — auth, validation, errors
│   │   ├── routes/          — API endpoints
│   │   ├── migrations/      — схема БД
│   │   ├── seed.js          — начальные данные
│   │   └── views/           — шаблоны/фронтенд
│   ├── tests/               — автотесты
│   ├── .env.example         — шаблон переменных
│   └── package.json
├── frontend/                — фронтенд (если отдельный)
├── CHANGELOG.md             — история изменений
├── README.md                — как запустить
├── API.md                   — описание API
└── .gitignore               — обязательно: .env, node_modules, *.log
```

---

*Этот алгоритм универсален для любого Node.js проекта. Valentina — Product Owner, все решения через неё.*
*Ревью: Claw (Claude Opus) + Codex (OpenAI gpt-5.2), 23 февраля 2026.*
