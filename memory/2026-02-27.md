# 2026-02-27

## Code Review Fixes (commit d57fc4a → main)

Файл `CODE_REVIEW_2026-02-27.md` — полный ревью от main-бота (Opus).

### Что исправлено:
1. **CRITICAL #1 — Миграции при каждом старте**: таблица `_migrations` + `runOnce()` — каждая миграция выполняется только один раз
2. **CRITICAL #2 — SSL**: `rejectUnauthorized` конфигурируемый через `DB_SSL_REJECT_UNAUTHORIZED` env (по умолчанию false для Neon)
3. **CRITICAL #3 — CSP**: включён с `unsafe-inline` для script/style + `frameSrc` для Metabase iframe
4. **HIGH #4 — JWT_SECRET**: warning в production если не задан; отдельный `JWT_REFRESH_SECRET`
5. **HIGH #8 — PATCH autoLinkEntities**: добавлен `autoLinkEntities` + `logAction` в PATCH handler (был только в PUT)
6. **HIGH #12 — Cleanup refresh_tokens**: очистка при старте + каждые 24ч
7. **frameSrc для BI iframe**: `https://benthic-hull.metabaseapp.com` в CSP

### Main-бот уже сделал (слито):
- Миграции 019-022 (payment_frequency, BI views, schema extension, sale_item_type)
- createBIViews(), syncMetabase()
- Smart mini-cards for entities (потом revert)
- Много UI фиксов (map, searchable dropdowns, equipment selector и т.д.)

### Не исправлено (LOW/MEDIUM):
- #6: frontend.js 6749 строк — рефакторинг позже
- #7: Нет тестов — Jest+Supertest позже
- #9: contract-card оптимизация запросов
- #10: Пагинация reports
- #14-17: structured logging, XSS middleware, API.md

---

## Задеплоено (из предыдущей сессии, поздно 26-го)
- Коммит `81a6189` (main) — 4 задачи contract UI:
  1. **Collapsible duration section** — "+ Добавить срок действия" для всех типов договоров и ДС
  2. **Contract items (позиции договора)** — повторяемые строки (название+сумма) для Подряда/Услуг/Купли-продажи; auto-sum в `contract_amount` (readonly)
  3. **BI dashboard page** — кнопка в sidebar + iframe с localStorage URL
  4. **Contract mini-cards** — тип, стороны, предмет, сумма вместо всех properties

## Технические детали
- ID поля срока: `f_duration_date` (не `f_contract_end_date`); маппится в оба: `duration_date` и `contract_end_date`
- `contract_amount` readonly когда есть contract_items
- Ветка `feature/contract-ui-tasks` влита в dev → main
- ~310 строк добавлено в frontend.js

## TODO (перенесено)
- Проверить что все 4 фичи работают на проде
- Вставить URL Metabase в BI настройки если не сделано

## Деплой
- Коммит `d57fc4a` (main) — code review fixes задеплоен
- Health endpoint не настроен (/ возвращает HTML SPA; нет GET /health)
