# Алгоритм разработки

## Роли

| Роль | Кто | Что делает |
|------|-----|-----------|
| Product Owner | Valentina | Ставит задачи, утверждает планы, приоритеты |
| Архитектор | Claw | Проектирует структуру, БД, безопасность |
| Разработчик | Claw | Пишет код |
| Code Reviewer | Codex (OpenAI) | Проверяет код перед деплоем |
| QA | Claw + Valentina | Автотесты + ручная проверка |
| DevOps | Claw | CI/CD, деплой, мониторинг |

---

## Ветки Git

- `dev` — черновик. Здесь пишем, ломаем, чиним
- `main` — чистовик. Только проверенный код. Автодеплой на сервер

---

## Цикл разработки (на каждую задачу)

### 1. Постановка задачи (Product Owner)
- Valentina описывает что нужно сделать
- Можно голосом, текстом, скриншотом — как удобно

### 2. Анализ и план (Архитектор)
- Claw анализирует задачу
- Пишет план на 3-5 пунктов
- Указывает затронутые файлы
- **Ждёт ОК от Valentina**

### 3. Разработка (Developer)
```
git checkout dev
```
- Бэкап файлов перед редактированием
- Маленькие изменения, не переписывать файлы целиком
- После каждого изменения — проверка синтаксиса:
```
node --check файл.js
```

### 4. Автотесты (QA автоматический)
```
npm test
```
- Все тесты должны пройти
- Если тесты упали — исправить до коммита

### 5. Code Review (Codex)
```
bash scripts/codex-review.sh server/src
```
- Codex проверяет: безопасность, архитектура, производительность, лучшие практики
- Если есть CRITICAL или HIGH замечания — исправить
- MEDIUM — на усмотрение
- LOW — можно отложить

### 6. Самопроверка (Security + Quality)
Чеклист перед коммитом:
- [ ] Нет захардкоженных паролей/ключей в коде
- [ ] Все входные данные валидируются
- [ ] SQL-запросы параметризованы ($1, $2)
- [ ] Нет innerHTML с пользовательскими данными без экранирования
- [ ] Ошибки обрабатываются, стектрейсы не утекают клиенту
- [ ] Новые endpoints защищены авторизацией

### 7. Коммит в dev
```
git add .
git commit -m "Понятное описание на английском"
git push origin dev
```

### 8. CI (GitHub Actions)
- Автоматически запускаются тесты при push в dev
- Если CI красный — исправить

### 9. Merge в production
```
git checkout main
git merge dev
git push origin main
```
- Render автоматически деплоит за ~2 минуты

### 10. Проверка на живом сайте (QA ручной)
Чеклист после деплоя:
- [ ] Сайт открывается
- [ ] Логин работает
- [ ] Создание записи работает
- [ ] Редактирование работает
- [ ] Удаление работает
- [ ] Связи работают
- [ ] Проверить с телефона
- [ ] Проверить health endpoint

### 11. Документация (Tech Writer)
- Обновить README.md если изменились инструкции
- Обновить API.md если изменились endpoints
- Записать в memory что сделано

---

## Если сломалось в production

```
git checkout main
git revert HEAD
git push origin main
```
→ Render откатит за 2 минуты
→ Чиним в dev → повторяем цикл

---

## Правила

1. **Никогда** не писать код сразу в main
2. **Никогда** не деплоить без тестов и ревью
3. **Никогда** не хранить секреты в коде (только в Render Dashboard / .env.local)
4. **Всегда** план → ОК → код → тесты → ревью → деплой
5. **Маленькие частые коммиты** лучше одного большого
6. **Максимум 1 задача** за раз
7. Если не уверен — **спроси**

---

## Инструменты

| Что | Зачем |
|-----|-------|
| Git + GitHub | Версионирование кода |
| Jest + Supertest | Автотесты |
| GitHub Actions | CI — автоматический запуск тестов |
| Codex (OpenAI) | Code review |
| Render.com | Хостинг (автодеплой из main) |
| PostgreSQL | База данных |
| Helmet.js | HTTP security headers |
| bcrypt + JWT | Авторизация |
| Joi | Валидация данных |
| express-rate-limit | Защита от DDoS |

---

## Структура проекта

```
project/
├── .github/workflows/   — CI конфигурация
├── scripts/
│   └── codex-review.sh  — скрипт code review
├── server/
│   ├── src/
│   │   ├── index.js         — точка входа
│   │   ├── db.js            — подключение к БД
│   │   ├── middleware/      — auth, validation, errors
│   │   ├── routes/          — API endpoints
│   │   ├── migrations/      — схема БД
│   │   ├── seed.js          — начальные данные
│   │   └── frontend.js      — интерфейс
│   ├── tests/               — автотесты
│   ├── .env.example         — шаблон переменных
│   └── package.json
├── WORKFLOW.md              — этот файл
├── README.md                — как запустить
├── API.md                   — описание API
└── .gitignore
```

---

*Этот алгоритм универсален для любого Node.js проекта.*
