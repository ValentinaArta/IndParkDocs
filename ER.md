# ER-схема IndParkDocs

> Актуально на: 2026-02-26 | Миграции: 003–016

---

## Структура таблиц БД

```mermaid
erDiagram
    entity_types["Типы сущностей"] {
        int    id          PK "Идентификатор"
        string name        UK "Код (англ.)"
        string name_ru        "Название (рус.)"
        string icon           "Иконка"
        string color          "Цвет"
        int    sort_order     "Порядок"
    }
    field_definitions["Определения полей"] {
        int    id               PK "Идентификатор"
        int    entity_type_id   FK "Тип сущности"
        string name                "Код поля"
        string name_ru             "Название поля"
        string field_type          "Тип (text/select/…)"
        jsonb  options             "Варианты выбора"
        bool   required            "Обязательное"
        int    sort_order          "Порядок"
    }
    entities["Сущности"] {
        int       id              PK "Идентификатор"
        int       entity_type_id  FK "Тип сущности"
        string    name               "Название"
        jsonb     properties         "Свойства"
        int       parent_id       FK "Родитель"
        timestamp created_at         "Создано"
        timestamp deleted_at         "Удалено"
    }
    relation_types["Типы связей"] {
        int    id      PK "Идентификатор"
        string name    UK "Код (англ.)"
        string name_ru    "Название (рус.)"
        string color      "Цвет"
    }
    relations["Связи"] {
        int       id              PK "Идентификатор"
        int       from_entity_id  FK "От сущности"
        int       to_entity_id    FK "К сущности"
        string    relation_type   FK "Тип связи"
        timestamp created_at         "Создано"
    }
    users["Пользователи"] {
        int    id            PK "Идентификатор"
        string username      UK "Логин"
        string password_hash    "Хэш пароля"
    }

    entity_types    ||--o{ entities          : "тип сущности"
    entity_types    ||--o{ field_definitions : "поля типа"
    entities        }o--o| entities          : "родитель"
    relation_types  ||--o{ relations         : "тип связи"
    entities        ||--o{ relations         : "от кого"
    entities        ||--o{ relations         : "к кому"
```

---

## Доменная схема — сущности и связи

```mermaid
graph TD
    %% ─── ТЕРРИТОРИЯ ───────────────────────────────
    LP["🌍 Земельный участок<br/>─────────────────<br/>кадастровый номер<br/>площадь га<br/>разрешённое использование"]
    LPP["🗺 Часть ЗУ<br/>─────────────────<br/>описание<br/>площадь га"]
    BLD["🏢 Корпус<br/>─────────────────<br/>адрес<br/>общая площадь м²<br/>собственник → компания"]
    RM["🚪 Помещение<br/>─────────────────<br/>тип помещения<br/>площадь м²<br/>этаж"]
    EQ["⚙️ Оборудование<br/>─────────────────<br/>категория<br/>вид<br/>инв. номер / серийный номер<br/>год / производитель<br/>статус<br/>собственник → компания"]

    %% ─── КОМПАНИИ ─────────────────────────────────
    CO["🏛 Компания<br/>─────────────────<br/>наше / стороннее<br/>ИНН<br/>контактное лицо<br/>телефон / email"]

    %% ─── ДОКУМЕНТЫ ────────────────────────────────
    CT["📄 Договор<br/>─────────────────<br/>тип (Аренды / Подряда / …)<br/>номер / дата / срок до<br/>наше юрлицо → компания<br/>контрагент → компания<br/>НДС %"]
    SP["📎 Доп. соглашение<br/>─────────────────<br/>тип (наследуется)<br/>номер / дата<br/>что поменялось"]
    ACT["📝 Акт<br/>─────────────────<br/>номер / дата<br/>позиции: оборудование,<br/>сумма, описание<br/>итого ₽ / комментарий"]
    ORD["📜 Приказ<br/>─────────────────<br/>номер / дата<br/>тип (консервация / …)<br/>кем выдан"]

    %% ─── Иерархия родитель → потомок ─────────────
    LP  -->|"родитель"| LPP
    BLD -->|"родитель-собственник"| CO
    BLD -->|"родитель"| RM
    EQ  -->|"родитель-иерархия"| EQ
    CT  -->|"родитель"| SP
    CT  -->|"родитель"| ACT

    %% ─── Связи (таблица relations) ────────────────
    BLD -.->|"расположен на"| LP
    EQ  -.->|"расположен в"| BLD
    EQ  -.->|"расположен в"| RM
    CO  -.->|"сторона договора"| CT
    EQ  -.->|"предмет договора"| CT
    RM  -.->|"предмет договора"| CT
    EQ  -.->|"предмет акта"| ACT
    SP  -.->|"дополнение к"| CT
    ACT -.->|"дополнение к"| CT
    EQ  -.->|"на балансе"| CO

    %% ─── Стили ────────────────────────────────────
    style LP  fill:#d1fae5,stroke:#10B981,color:#065f46
    style LPP fill:#a7f3d0,stroke:#059669,color:#065f46
    style BLD fill:#e0e7ff,stroke:#6366F1,color:#1e1b4b
    style RM  fill:#ede9fe,stroke:#A78BFA,color:#1e1b4b
    style EQ  fill:#fef3c7,stroke:#F59E0B,color:#78350f
    style CO  fill:#dbeafe,stroke:#3B82F6,color:#1e40af
    style CT  fill:#fee2e2,stroke:#EF4444,color:#7f1d1d
    style SP  fill:#ede9fe,stroke:#8B5CF6,color:#1e1b4b
    style ACT fill:#fef3c7,stroke:#F59E0B,color:#78350f
    style ORD fill:#e0e7ff,stroke:#6366F1,color:#1e1b4b
```

---

## Типы связей

| Код | Описание | Направление |
|---|---|---|
| `located_in` | **расположен в** | оборудование → корпус / помещение |
| `located_on` | **расположен на** | корпус → земельный участок |
| `party_to` | **сторона договора** | компания → договор |
| `subject_of` | **предмет договора** | оборудование / помещение → договор / акт |
| `supplement_to` | **дополнение к** | доп.соглашение / акт → договор |
| `on_balance` | **на балансе** | оборудование → компания (собственник) |
| `rents` | арендует *(устар.)* | компания → помещение |
| `services` | обслуживает *(устар.)* | компания → оборудование |
| `installed_on` | установлен на *(устар.)* | оборудование → подкрановый путь |

---

## Поля договора по типам

| Тип договора | Дополнительные поля |
|---|---|
| **Аренды / Субаренды** | объекты аренды (помещения / площади / ставки), НДС, комментарии, срок, передача оборудования |
| **Подряда** | предмет, корпус, оборудование, сумма, авансы, срок выполнения |
| **Обслуживания** | описание работ, корпус, оборудование, стоимость, комментарий |
| **Услуг / Купли-продажи / Поставки / Цессии** | базовые поля (номер, дата, стороны) |

---

## Иерархия родителей (parent_id)

```
🌍 Земельный участок
  └─ 🗺 Часть ЗУ

🏢 Корпус  ←  Собственник (наша компания)
  ├─ 🚪 Помещение
  └─ ⚙️ Оборудование
       └─ ⚙️ Оборудование (запчасть / узел / составная часть)

📄 Договор
  ├─ 📎 Доп. соглашение
  └─ 📝 Акт выполненных работ
```

---

*В БД есть, но скрыты в меню: Цех 🏭, Подкрановый путь 🛤, Документ 📋*
